@model RideShareFrontend.DTOs.RideCreateDto

@{
    ViewData["Title"] = ViewData["Title"] ?? "Post Ride"; // Fallback
    Layout = "_DriverLayout.cshtml";
}

<!DOCTYPE html>
<html>

<head>
    <title>@ViewData["Title"]</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <!-- Leaflet Geosearch CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /*            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;*/
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-container {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="datetime-local"],
        input[type="number"],
        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: #3498db;
            outline: none;
        }

        .map-container {
            height: 400px;
            width: 100%;
            margin: 20px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-box {
            flex: 1;
        }

        .search-button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #2980b9;
        }

        button[type="submit"] {
            background-color: #27ae60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }

        button[type="submit"]:hover {
            background-color: #219653;
        }

        .instructions {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <h2>Post a Ride</h2>
        @* Show TempData messages *@
        @if (ViewBag.Msg != null)
        {
            <div class="alert alert-warning">@ViewBag.Msg</div>
        }
        @if (ViewBag.Error != null)
        {
            <div class="alert alert-danger">@ViewBag.Error</div>
        }
        @if (ViewBag.Success != null)
        {
            <div class="alert alert-success">@ViewBag.Success</div>
        }

        <form asp-action="PostRide" method="post" id="postRideForm">
            @Html.AntiForgeryToken()

            <!-- Display summary of errors at top -->
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="search-container">
                <input type="text" id="origin-search" class="search-box" placeholder="Search origin..." />
                <button type="button" id="search-origin" class="search-button">Search</button>
            </div>
            <div class="form-group">
                <label asp-for="Origin"></label>
                <input asp-for="Origin" class="form-control" id="origin-input" />
                <span asp-validation-for="Origin" class="text-danger"></span>
                <p class="instructions">Or click on the map to set origin</p>
            </div>

            <div class="search-container">
                <input type="text" id="destination-search" class="search-box" placeholder="Search destination..." />
                <button type="button" id="search-destination" class="search-button">Search</button>
            </div>
            <div class="form-group">
                <label asp-for="Destination"></label>
                <input asp-for="Destination" class="form-control" id="destination-input" />
                <span asp-validation-for="Destination" class="text-danger"></span>
                <p class="instructions">Or click on the map to set destination</p>
            </div>

            <div id="map" class="map-container"></div>

            <div class="form-group">
                <label asp-for="DepartureTime"></label>
                <input asp-for="DepartureTime" type="datetime-local" class="form-control"
                    value="@DateTime.Now.AddHours(1).ToString("yyyy-MM-ddTHH:mm")" />
                <span asp-validation-for="DepartureTime" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="AvailableSeats"></label>
                <input asp-for="AvailableSeats" type="number" class="form-control" min="1" max="10" />
                <span asp-validation-for="AvailableSeats" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="PricePerSeat"></label>
                <input asp-for="PricePerSeat" type="number" step="0.01" class="form-control" min="0.01" />
                <span asp-validation-for="PricePerSeat" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="RoutePoints"></label>
                <input asp-for="RoutePoints" class="form-control" />
                <span asp-validation-for="RoutePoints" class="text-danger"></span>
                <p class="instructions">Enter intermediate route points (comma-separated)</p>
            </div>

            <button type="submit" class="btn btn-primary">Post Ride</button>
        </form>
    </div>
    
    <!-- Bootstrap JS (v5.x) Bundle includes Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Leaflet Geosearch JS -->
    <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.umd.js"></script>

    <script>
        function handleFormSubmit() {
            console.log("Form submission started"); // Check browser console
            //document.getElementById('formStatus').textContent = "Form is submitting...";
            return true; // Allow form to submit
        }


        // Initialize map centered on India
        let map = L.map('map').setView([20.5937, 78.9629], 5);
        let originMarker, destinationMarker;
        let routeLayer = L.layerGroup().addTo(map);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Initialize geosearch provider
        const provider = new GeoSearch.OpenStreetMapProvider();

        // DOM elements
        const originInput = document.getElementById("origin-input");
        const destinationInput = document.getElementById("destination-input");
        const originSearch = document.getElementById("origin-search");
        const destinationSearch = document.getElementById("destination-search");
        const searchOriginBtn = document.getElementById("search-origin");
        const searchDestinationBtn = document.getElementById("search-destination");

        // Map click handler
        map.on('click', function (e) {
            if (!originMarker) {
                setOrigin(e.latlng);
            } else if (!destinationMarker) {
                setDestination(e.latlng);
                drawRoute();
            }
        });

        // Search origin location
        searchOriginBtn.addEventListener('click', function () {
            const query = originSearch.value;
            if (query) {
                searchLocation(query, setOrigin);
            }
        });

        // Search destination location
        searchDestinationBtn.addEventListener('click', function () {
            const query = destinationSearch.value;
            if (query) {
                searchLocation(query, setDestination, function () {
                    if (originMarker) drawRoute();
                });
            }
        });

        function setOrigin(latlng) {
            if (originMarker) map.removeLayer(originMarker);
            originMarker = L.marker(latlng, {
                draggable: true,
                icon: L.divIcon({
                    className: 'origin-marker',
                    html: '<div style="background-color: #3498db; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [24, 24]
                })
            }).addTo(map).bindPopup('Origin').openPopup();

            reverseGeocode(latlng, originInput);

            originMarker.on('dragend', function () {
                reverseGeocode(originMarker.getLatLng(), originInput);
                if (destinationMarker) drawRoute();
            });
        }

        function setDestination(latlng) {
            if (destinationMarker) map.removeLayer(destinationMarker);
            destinationMarker = L.marker(latlng, {
                draggable: true,
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div style="background-color: #e74c3c; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [24, 24]
                })
            }).addTo(map).bindPopup('Destination').openPopup();

            reverseGeocode(latlng, destinationInput);

            destinationMarker.on('dragend', function () {
                reverseGeocode(destinationMarker.getLatLng(), destinationInput);
                drawRoute();
            });
        }

        async function reverseGeocode(latlng, inputBox) {
            try {
                const response = await fetch(`/reverse-geocode?lat=${latlng.lat}&lng=${latlng.lng}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                console.log(data);

                if (data && data.address) {
                    let val = data.address.county || data.address.state_district || data.address.state || data.address.city;
                    inputBox.value = val;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
        }


        function drawRoute() {
            if (!originMarker || !destinationMarker) return;

            routeLayer.clearLayers();

            const origin = originMarker.getLatLng();
            const destination = destinationMarker.getLatLng();

            // Draw a simple straight line (for actual routing you'd need a routing service)
            const route = L.polyline([origin, destination], {
                color: '#27ae60',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(routeLayer);

            // Adjust map view to show both points
            map.fitBounds(L.latLngBounds(origin, destination), {
                padding: [50, 50]
            });
        }



        async function searchLocation(query, callback, success) {
            try {
                const response = await fetch(`/geocode?q=${encodeURIComponent(query)}`);

                if (!response.ok) {
                    throw new Error(`Geocoding failed: ${response.status}`);
                }

                const results = await response.json();

                console.log(results);

                if (results.length > 0) {
                    const latlng = L.latLng(results[0].lat, results[0].lon);
                    callback(latlng);
                    if (success) success();
                    return true;
                }
                return false;
            } catch (error) {
                console.error("Geocoding error:", error);
                alert("Location search failed. Please try again later.");
                return false;
            }
        }


        //function searchLocation(query, callback, success) {
        //    provider.search({ query: query })
        //        .then(function (result) {
        //            if (result.length > 0) {
        //                const latlng = L.latLng(result[0].y, result[0].x);
        //                map.setView(latlng, 13);
        //                callback(latlng);
        //                if (success) success();
        //            }
        //        });
        //}



        // Helper function to get the auth token (you'll need to implement this based on how you store tokens)
        function getAuthToken() {
            // This could come from localStorage, cookies, etc.
            return localStorage.getItem('authToken');
        }

    </script>
</body>

</html>